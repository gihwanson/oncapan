"""
AI ëŒ“ê¸€ ìƒì„± ëª¨ë“ˆ
- OpenAI GPTë¥¼ ì´ìš©í•œ ìì—°ìŠ¤ëŸ¬ìš´ ëŒ“ê¸€ ìƒì„±
- ì‹¤ì œ ëŒ“ê¸€ ëª¨ë°©ì— ì§‘ì¤‘
"""

from openai import OpenAI
import logging
from typing import Optional, List, Dict
import datetime
import re
from collections import Counter

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# httpx ë¡œê·¸ ë¹„í™œì„±í™”
logging.getLogger("httpx").setLevel(logging.WARNING)


class AICommentGenerator:
    def __init__(self, api_key: str, learning_analyzer=None):
        self.client = OpenAI(api_key=api_key)
        self.model = "gpt-4o-mini"  # ìµœì‹  ë¯¸ë‹ˆ ëª¨ë¸ë¡œ ì—…ê·¸ë ˆì´ë“œ (ì§§ì€ ëŒ“ê¸€ ëª¨ë°© í’ˆì§ˆ í–¥ìƒ)
        self.learning_analyzer = learning_analyzer  # í•™ìŠµ ë¶„ì„ê¸° (ì„ íƒì )
    
    def generate_comment(self, post_content: str, post_title: str = "", actual_comments: List[str] = None) -> Optional[str]:
        """
        ê²Œì‹œê¸€ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ìì—°ìŠ¤ëŸ¬ìš´ ëŒ“ê¸€ ìƒì„±
        - post_title: ê²Œì‹œê¸€ ì œëª©
        - post_content: ê²Œì‹œê¸€ ë³¸ë¬¸
        - actual_comments: ì´ ê²Œì‹œê¸€ì— ì‹¤ì œë¡œ ë‹¬ë¦° ëŒ“ê¸€ ëª©ë¡ (ìµœìš°ì„ !)
        
        ì£¼ì˜: ì‹¤ì œ ëŒ“ê¸€ì´ ì—†ìœ¼ë©´ Noneì„ ë°˜í™˜í•˜ì—¬ ëŒ“ê¸€ ì‘ì„±ì„ ê±´ë„ˆëœë‹ˆë‹¤.
        """
        # ì‹¤ì œ ëŒ“ê¸€ì´ ì—†ìœ¼ë©´ ëŒ“ê¸€ ì‘ì„±í•˜ì§€ ì•ŠìŒ
        if not actual_comments or len(actual_comments) == 0:
            logger.info("ì‹¤ì œ ëŒ“ê¸€ì´ ì—†ëŠ” ê²Œì‹œê¸€ì€ ëŒ“ê¸€ ì‘ì„±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
            return None
        
        # ë³¸ë¬¸ ë‚´ìš© ì €ì¥ (í›„ì²˜ë¦¬ì—ì„œ ì‚¬ìš©)
        self._current_post_content = post_content
        self._current_post_title = post_title
        
        # ëŒ“ê¸€ì´ ì ì„ ë•Œ(3ê°œ ì´í•˜) ë³¸ë¬¸ ë¶„ì„ ê°•í™” í”Œë˜ê·¸
        has_few_comments = len(actual_comments) <= 3
        
        max_retries = 3
        
        # í‚¤ì›Œë“œ ë¯¸ë¦¬ ì¶”ì¶œ (ê²€ì¦ìš©)
        keywords = self._extract_keywords(actual_comments) if actual_comments else []
        
        for attempt in range(max_retries):
            try:
                # ì•ˆì „í•œ ë¬¸ìì—´ ì²˜ë¦¬
                safe_title = self._safe_string(post_title)
                safe_content = self._safe_string(post_content[:500])  # ë³¸ë¬¸ì€ 500ìë¡œ ì œí•œ
                
                # ì‹¤ì œ ëŒ“ê¸€ì´ ìˆìœ¼ë©´ ë¬´ì¡°ê±´ ëª¨ë°© ëª¨ë“œ
                # ëŒ“ê¸€ì´ ì ì„ ë•ŒëŠ” ë³¸ë¬¸ ë¶„ì„ ê°•í™”
                comment = self._generate_with_actual_comments(
                    safe_title, safe_content, actual_comments, keywords, has_few_comments
                )
                
                if comment:
                    # ë¡œê·¸ ê°„ì†Œí™”: ìƒì„±ëœ ëŒ“ê¸€ë§Œ ê°„ë‹¨íˆ ì¶œë ¥
                    logger.debug(f"[ì‹œë„ {attempt + 1}] ìƒì„±ëœ ëŒ“ê¸€: {comment}")
                    
                    # í‚¤ì›Œë“œ í¬í•¨ ì—¬ë¶€ í™•ì¸ (ëŒ“ê¸€ì´ ì ì„ ë•ŒëŠ” ì™„í™”)
                    if keywords and not has_few_comments:  # ëŒ“ê¸€ì´ ì ì„ ë•ŒëŠ” í‚¤ì›Œë“œ ê²€ì¦ ì™„í™”
                        if not self._validate_keywords_in_comment(comment, keywords):
                            logger.warning(f"[ì‹œë„ {attempt + 1}] í‚¤ì›Œë“œ ë¯¸í¬í•¨ìœ¼ë¡œ í•„í„°ë§. ì›ë³¸: '{comment}', í‚¤ì›Œë“œ: {keywords}")
                            if attempt < max_retries - 1:
                                import time
                                time.sleep(0.5)  # ì¬ì‹œë„ ëŒ€ê¸° ì‹œê°„ ì¤„ì„
                                continue
                            else:
                                logger.error(f"[ì‹œë„ {attempt + 1}] í‚¤ì›Œë“œ í¬í•¨ ì‹¤íŒ¨. ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ë„ë‹¬.")
                    
                    # í›„ì²˜ë¦¬
                    processed_comment = self._post_process(comment)
                    
                    # í›„ì²˜ë¦¬ í›„ì—ë„ ìœ íš¨í•œ ëŒ“ê¸€ì´ë©´ ë°˜í™˜
                    if processed_comment:
                        # ì‹¤ì œ ëŒ“ê¸€ê³¼ì˜ ìœ ì‚¬ë„ ê²€ì¦ (ë‹¨ìˆœ ë³µì‚¬ ë°©ì§€)
                        if not self._validate_not_duplicate(processed_comment, actual_comments):
                            logger.warning(f"[ì‹œë„ {attempt + 1}] ì‹¤ì œ ëŒ“ê¸€ê³¼ ë„ˆë¬´ ìœ ì‚¬í•˜ì—¬ í•„í„°ë§. ìƒì„±: '{processed_comment}'")
                            if attempt < max_retries - 1:
                                import time
                                time.sleep(0.5)  # ì¬ì‹œë„ ëŒ€ê¸° ì‹œê°„ ì¤„ì„
                                continue
                            else:
                                logger.error(f"[ì‹œë„ {attempt + 1}] ì‹¤ì œ ëŒ“ê¸€ê³¼ ìœ ì‚¬ë„ ê²€ì¦ ì‹¤íŒ¨. ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ë„ë‹¬.")
                        
                        # í‚¤ì›Œë“œ ì¬í™•ì¸ì€ ì œê±° (ì›ë³¸ì—ì„œ í†µê³¼í–ˆìœ¼ë©´ OK, í›„ì²˜ë¦¬ë¡œ ì˜ë ¤ë‚˜ê°ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ)
                        # í›„ì²˜ë¦¬ í›„ í‚¤ì›Œë“œ ê²€ì¦ì€ ë¶ˆí•„ìš”í•œ ì¬ì‹œë„ë¥¼ ìœ ë°œí•  ìˆ˜ ìˆì–´ ì œê±°
                        
                        # ë””ë²„ê·¸ ë¡œê·¸ ê¸°ë¡
                        self._log_generation(post_title, post_content, actual_comments, processed_comment)
                        return processed_comment
                    else:
                        # í›„ì²˜ë¦¬ì—ì„œ í•„í„°ë§ëœ ê²½ìš° ì¬ì‹œë„
                        logger.warning(f"[ì‹œë„ {attempt + 1}] í›„ì²˜ë¦¬ì—ì„œ í•„í„°ë§ë¨. ì›ë³¸: '{comment}' -> None")
                        if attempt < max_retries - 1:
                            import time
                            time.sleep(0.5)  # ì¬ì‹œë„ ëŒ€ê¸° ì‹œê°„ ì¤„ì„
                            continue
                        else:
                            logger.error(f"[ì‹œë„ {attempt + 1}] ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ë„ë‹¬. ëŒ“ê¸€ ìƒì„± ì‹¤íŒ¨.")
                else:
                    logger.warning(f"[ì‹œë„ {attempt + 1}] _generate_with_actual_commentsê°€ Noneì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤.")
                    if attempt < max_retries - 1:
                        logger.info(f"[ì‹œë„ {attempt + 1}] ì¬ì‹œë„ ëŒ€ê¸° ì¤‘...")
                        import time
                        time.sleep(0.5)  # ì¬ì‹œë„ ëŒ€ê¸° ì‹œê°„ ì¤„ì„
                        continue
                    else:
                        logger.error(f"[ì‹œë„ {attempt + 1}] ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ë„ë‹¬. ëŒ“ê¸€ ìƒì„± ì‹¤íŒ¨.")
                    
            except Exception as e:
                logger.error(f"ëŒ“ê¸€ ìƒì„± ì˜¤ë¥˜ (ì‹œë„ {attempt + 1}/{max_retries}): {e}")
                import traceback
                logger.error(f"íŠ¸ë ˆì´ìŠ¤ë°±: {traceback.format_exc()}")
                if attempt < max_retries - 1:
                    import time
                    time.sleep(0.5)  # ì¬ì‹œë„ ëŒ€ê¸° ì‹œê°„ ì¤„ì„
                    continue
                return None
        
        logger.error("ëª¨ë“  ì¬ì‹œë„ ì‹¤íŒ¨. None ë°˜í™˜")
        return None
    
    def _extract_keywords(self, comments: List[str], max_length: int = 10) -> List[str]:
        """ëŒ“ê¸€ì—ì„œ ê°€ì¥ ë§ì´ ë‚˜ì˜¨ í‚¤ì›Œë“œ ì¶”ì¶œ (10ì ì´ë‚´ ëŒ“ê¸€ë§Œ ë¶„ì„)
        
        Args:
            comments: ëŒ“ê¸€ ëª©ë¡ (ë¬¸ìì—´ ë˜ëŠ” dict í˜•íƒœ ê°€ëŠ¥)
            max_length: ë¶„ì„í•  ëŒ“ê¸€ì˜ ìµœëŒ€ ê¸¸ì´ (ê¸°ë³¸ê°’: 10ì)
        """
        # 1) ë¨¼ì € ì „ë¶€ í…ìŠ¤íŠ¸ë¡œ ì •ë¦¬ (dict í˜•íƒœë„ ì²˜ë¦¬)
        comment_texts: List[str] = []
        for c in comments:
            if isinstance(c, str):
                t = c
            else:
                # dict í˜•íƒœì¼ ê²½ìš° content ìš°ì„  ì‚¬ìš©
                t = c.get('content', str(c)) if isinstance(c, dict) else str(c)
            if t and len(t.strip()) > 0:
                comment_texts.append(t.strip())
        
        if not comment_texts:
            return []
        
        # 2) ì—¬ê¸°ë¶€í„°ëŠ” comment_texts ê¸°ì¤€ìœ¼ë¡œ ì‚¬ìš©
        # 10ì ì´ë‚´ ëŒ“ê¸€ë§Œ í•„í„°ë§
        short_comments = [c for c in comment_texts if len(c) <= max_length]
        
        if not short_comments:
            # 10ì ì´ë‚´ ëŒ“ê¸€ì´ ì—†ìœ¼ë©´ ì „ì²´ ëŒ“ê¸€ ì‚¬ìš©
            short_comments = comment_texts
        
        # ì»¤ë®¤ë‹ˆí‹° íŠ¹ìˆ˜ ìš©ì–´ ì‚¬ì „ (ìš°ì„  ì¶”ì¶œ)
        special_terms = [
            'ë‹´íƒ€', 'ë ‰ì¹´', 'í¬ì „', 'í¬ë°”', 'ë‹¨í¬ë°”', 'ê¹Šì „', 'ëŒ“ë…¸', 'ë©˜ì§•',
            'ê³¨ìŠ¤', 'ì˜¤í´', 'ëŠë°”', 'í¬ë³´', 'ë¯ˆë¸Œ', 'í•´ì¶•', 'ìƒˆì¶•', 'ì¼ì•¼',
            'ë‹´ë°°', 'ìŒˆë°°', 'ë§›ë‹´', 'ë§›ì ', 'ë§›ì €', 'ë§›ì•„', 'ë§›ì»¤', 'ë§›ëŸ°ì¹˜',
            'ë¬´ë¸Œ', 'í›„ë•¡', 'ê³ ìš°', 'ê¿€ì¼', 'ê°œê¿€ì¼', 'ì«„ê¹ƒ', 'ì—°ì¥', 'í˜ì´ë°±',
            'ì¶”ì›Œ', 'ì¶¥', 'ê°ê¸°', 'í•œìˆ¨', 'ì‹ê³¤ì¦', 'ì¡¸ë¦½', 'ëŸ°ì¹˜', 'ì ì‹¬',
            'ë²³ê³„', 'ë²³ì»¨', 'ì¿¨ê±°', 'ì…ê¸ˆ', 'ì§€ì—°', 'ì¡°íšŒìˆ˜',
            'í•«ì‹ìŠ¤', 'ì›í”Œì›', 'ë„í•‘', 'ëŒë°œ', 'ëŒëŒ€ê¸°', 'ì‹ ë¼ë©´', 'ì½”ì½”ì•„',
            'í”Œí•¸', 'ì˜¤ë°”', 'ë§ˆí•¸', 'ì„ì‚´', 'ì„ì‚¬', 'ë…ì‚¬', 'í›ˆì¹´', 'í™”ë ¥',
            'í–„ë¶€ê¸°', 'ì•¼í‚¤í† ë¦¬', 'ë¬´í•œë„ì „', 'ëŸ°ë‹ë§¨'
        ]
        
        all_words = []
        found_special_terms = []
        
        for comment in short_comments:
            # íŠ¹ìˆ˜ ìš©ì–´ ìš°ì„  ê²€ìƒ‰
            comment_lower = comment.lower()
            for term in special_terms:
                if term in comment_lower and term not in found_special_terms:
                    found_special_terms.append(term)
            
            # ë„ì–´ì“°ê¸° ê¸°ì¤€ìœ¼ë¡œ ë‹¨ì–´ ë¶„ë¦¬ (ìš°ì„ )
            words_by_space = re.findall(r'[ê°€-í£]+', comment)
            for word in words_by_space:
                if 2 <= len(word) <= 4:  # 2-4ê¸€ìë§Œ
                    all_words.append(word)
            
            # ë„ì–´ì“°ê¸°ë¡œ ë¶„ë¦¬ë˜ì§€ ì•Šì€ ê²½ìš°, í•œê¸€ë§Œ ì¶”ì¶œí•˜ì—¬ ë¶€ë¶„ ë¬¸ìì—´ ì¶”ì¶œ (ë³´ì¡°)
            korean_text = re.sub(r'[^ê°€-í£]', '', comment)
            if len(korean_text) > 0:
                # 2-4ê¸€ì ê¸¸ì´ì˜ ë¶€ë¶„ ë¬¸ìì—´ ì¶”ì¶œ (ë‹¨ì–´ ê²½ê³„ ê³ ë ¤)
                for length in range(2, min(5, len(korean_text) + 1)):  # ìµœëŒ€ 4ê¸€ì
                    for i in range(len(korean_text) - length + 1):
                        word = korean_text[i:i+length]
                        if len(word) >= 2:
                            all_words.append(word)
        
        # ë¹ˆë„ìˆ˜ ê³„ì‚°
        word_counter = Counter(all_words)
        
        # íŠ¹ìˆ˜ ìš©ì–´ëŠ” ìš°ì„  ì¶”ê°€
        for term in found_special_terms:
            if term in word_counter:
                word_counter[term] += 10  # ê°€ì¤‘ì¹˜ ë¶€ì—¬
        
        # ì œì™¸í•  ì¼ë°˜ì ì¸ ë‹¨ì–´ë“¤ ë° ì–´ë¯¸/ì ‘ë¯¸ì‚¬
        exclude_words = {
            'ì¢‹ì•„ìš”', 'ë§ì•„ìš”', 'ìˆ˜ê³ ', 'ê³µê°', 'ì •ë³´', 'ê°ì‚¬', 'ê³ ë§ˆì›Œ', 'ê³ ë§ˆì›Œìš”',
            'ì¢‹ì•„', 'ë§ì•„', 'ê·¸ë˜', 'ê·¸ë ‡', 'ì´ê±°', 'ì €ê±°', 'ì´ê²ƒ', 'ì €ê²ƒ',
            'ë•Œë¬¸', 'ë•Œë¬¸ì—', 'ê·¸ë˜ì„œ', 'ê·¸ëŸ°ë°', 'ê·¸ë¦¬ê³ ', 'í•˜ì§€ë§Œ', 'ê·¸ëŸ¬ë‚˜',
            'ëŒ“ê¸€', 'ê²Œì‹œê¸€', 'ì‘ì„±', 'ë“±ë¡', 'ìˆ˜ì •', 'ì‚­ì œ', 'ì‹ ê³ ',
            'ì˜¤ëŠ˜', 'ë‚´ì¼', 'ì–´ì œ', 'ì§€ê¸ˆ', 'ì´ì œ', 'ê·¸ë•Œ', 'ì–¸ì œ',
            'ì—¬ê¸°', 'ì €ê¸°', 'ê±°ê¸°', 'ì–´ë””', 'ì–´ë””ì„œ', 'ì–´ë””ì—',
            'ì´ë ‡ê²Œ', 'ì €ë ‡ê²Œ', 'ê·¸ë ‡ê²Œ', 'ì–´ë–»ê²Œ', 'ì™œ', 'ë¬´ì—‡', 'ë¬´ìŠ¨',
            'ìˆì–´', 'ì—†ì–´', 'ìˆë„¤', 'ì—†ë„¤', 'ìˆì–´ìš”', 'ì—†ì–´ìš”',
            'ë˜ë„¤', 'ë˜ë„¤ìš”', 'ë˜ë‚˜', 'ë˜ë‚˜ìš”', 'ë˜ëŠ”', 'ë˜ëŠ”ë°',
            'ê°€ë„¤', 'ê°€ë„¤ìš”', 'ê°€ë‚˜', 'ê°€ë‚˜ìš”', 'ê°€ëŠ”', 'ê°€ëŠ”ë°',
            'í•˜ë„¤', 'í•˜ë„¤ìš”', 'í•˜ë‚˜', 'í•˜ë‚˜ìš”', 'í•˜ëŠ”', 'í•˜ëŠ”ë°',
            'ë³´ë„¤', 'ë³´ë„¤ìš”', 'ë³´ë‚˜', 'ë³´ë‚˜ìš”', 'ë³´ëŠ”', 'ë³´ëŠ”ë°',
            'ë¨¹ë„¤', 'ë¨¹ë„¤ìš”', 'ë¨¹ë‚˜', 'ë¨¹ë‚˜ìš”', 'ë¨¹ëŠ”', 'ë¨¹ëŠ”ë°',
            'ë“œë„¤', 'ë“œë„¤ìš”', 'ë“œë‚˜', 'ë“œë‚˜ìš”', 'ë“œëŠ”', 'ë“œëŠ”ë°',
            'í•´ì•¼', 'í•´ì•¼ì§€', 'í•´ì•¼ì§€', 'í•´ì•¼', 'í•´ì•¼', 'í•´ì•¼',
            # ì–´ë¯¸ íŒ¨í„´ (ê°•í™”)
            'ì…ë‹ˆ', 'ìŠµë‹ˆ', 'ì‹œë‹¤', 'ê²Œë§', 'ê²Œë˜', 'ê²Œí•˜', 'ì‹œê¸¸', 'í•˜ì…¨', 'í•˜ì…”', 'í•˜ì…¨ì–´',
            'ì¬ë°‹', 'ì¬ë°Œ', 'ì¬ë°ŒìŠµ', 'ì¬ë°‹ìŠµ', 'ì¬ë°‹ë‹ˆ', 'ì¬ë°Œë‹ˆ',
            'ë§›ë‹´ë°°', 'ë‹´ë°°í•˜', 'ê³ ìƒí•˜', 'í™”ì´íŒ…í•´', 'ì €ë„í•˜ê³ ', 'ìƒê°',
            # ì¡°ì‚¬
            'ì€', 'ëŠ”', 'ì´', 'ê°€', 'ì„', 'ë¥¼', 'ì˜', 'ì—', 'ì—ì„œ', 'ì™€', 'ê³¼',
            'ë„', 'ë§Œ', 'ì¡°ì°¨', 'ê¹Œì§€', 'ë¶€í„°', 'ì—ê²Œ', 'í•œí…Œ', 'ê»˜', 'ë¡œ', 'ìœ¼ë¡œ',
            'ì²˜ëŸ¼', 'ê°™ì´', 'ë§Œí¼', 'ë³´ë‹¤', 'ë§ˆë‹¤', 'ëŒ€ë¡œ', 'ì»¤ë…•',
            # ì˜ë¯¸ ì—†ëŠ” ë‹¨ì–´
            'ì•„ì', 'í•˜ê³ ', 'í•˜ê³ ì‹¶', 'í•˜ê³ í”„', 'í•˜ê³ ì‹¶ë„¤', 'í•˜ê³ í”„ë„¤',
        }
        
        # ì–´ë¯¸ë¡œ ëë‚˜ëŠ” íŒ¨í„´ (ì œì™¸)
        exclude_endings = (
            'í•©ë‹ˆë‹¤', 'ë‹ˆë‹¤', 'ë„¤ìš”', 'í•´ìš”', 'ì´ì—ìš”', 'ì˜ˆìš”', 'ì´ë„¤ìš”', 'ì´ì£ ',
            'ì´ë‹¤', 'ì…ë‹ˆë‹¤', 'ì´ì•¼', 'ì•¼', 'ì–´ìš”', 'ì•„ìš”', 'ì§€ìš”', 'ì£ ',
            'ê±°ì˜ˆìš”', 'ê±°ì•¼', 'ê±°ë‹¤', 'ë˜ìš”', 'ë¼ìš”', 'ë˜ë„¤', 'ë˜ë‚˜', 'ë˜ëŠ”',
            'ë ', 'ë˜ë©´', 'ë˜ë‹ˆ', 'í•˜ë„¤', 'í•˜ë‚˜', 'í•˜ëŠ”', 'í• ', 'í•˜ë©´',
            'í•˜ë‹ˆ', 'í•˜ì£ ', 'í•˜ì„¸ìš”', 'ê°€ìš”', 'ê°€ë„¤', 'ê°€ëŠ”', 'ê°ˆ', 'ê°€ë©´',
            'ê°€ë‹ˆ', 'ê°€ì£ ', 'ê°€ì„¸ìš”', 'ì™€ìš”', 'ì™€ë„¤', 'ì˜¤ëŠ”', 'ì˜¬', 'ì˜¤ë©´',
            'ì˜¤ë‹ˆ', 'ì˜¤ì£ ', 'ì˜¤ì„¸ìš”', 'ìˆì–´', 'ìˆë„¤', 'ìˆëŠ”', 'ìˆì„', 'ìˆìœ¼ë©´',
            'ìˆë‹ˆ', 'ìˆì£ ', 'ìˆì–´ìš”', 'ì—†ì–´', 'ì—†ë„¤', 'ì—†ëŠ”', 'ì—†ì„', 'ì—†ìœ¼ë©´',
            'ì—†ë‹ˆ', 'ì—†ì£ ', 'ì—†ì–´ìš”', 'ì¢‹ì•„', 'ì¢‹ë„¤', 'ì¢‹ì€', 'ì¢‹ì„', 'ì¢‹ìœ¼ë©´',
            'ì¢‹ë‹ˆ', 'ì¢‹ì£ ', 'ì¢‹ì•„ìš”', 'ë‚˜ì™€', 'ë‚˜ë„¤', 'ë‚˜ëŠ”', 'ë‚ ', 'ë‚˜ë©´',
            'ë‚˜ë‹ˆ', 'ë‚˜ì£ ', 'ë‚˜ì™€ìš”', 'ë³´ë„¤', 'ë³´ëŠ”', 'ë³¼', 'ë³´ë©´', 'ë³´ë‹ˆ',
            'ë³´ì£ ', 'ë³´ì„¸ìš”', 'ë¨¹ë„¤', 'ë¨¹ëŠ”', 'ë¨¹ì„', 'ë¨¹ìœ¼ë©´', 'ë¨¹ë‹ˆ', 'ë¨¹ì£ ',
            'ë¨¹ì–´ìš”', 'í•˜ì‹œ', 'í•˜ì…”', 'í•˜ì‹ ', 'í•˜ì‹¤', 'í•˜ì‹œë©´', 'í•˜ì‹œë‹ˆ', 'í•˜ì‹œì£ ',
            'ëŠ”ë°', 'ì€ë°', 'ì¸ë°', 'ê±°ì•¼', 'ê±°ì˜ˆìš”', 'ê±°ë‹¤', 'ê±°ë„¤', 'ê±°ë„¤ìš”',
            'ê±°ë‚˜', 'ê±°ë‚˜ìš”', 'ê±°ëŠ”', 'ê±°ëŠ”ë°', 'ê±°ë‹ˆ', 'ê±°ë‹ˆìš”', 'ê±°ì£ ', 'ê±°ì„¸ìš”',
            'í•˜ì…¨', 'í•˜ì…”', 'í•˜ì…¨ì–´', 'í•˜ì‹œê¸¸', 'í•˜ì‹œê¸¸ìš”', 'í•˜ì‹œê¸¸ìš”',
            'ì¬ë°‹', 'ì¬ë°Œ', 'ì¬ë°‹ìŠµ', 'ì¬ë°ŒìŠµ', 'ì¬ë°‹ë‹ˆ', 'ì¬ë°Œë‹ˆ',
            'ì‹œê¸¸', 'ì‹œê¸¸ìš”', 'ì‹œê¸¸ìš”ìš”', 'ì‹œê¸¸ìš”ìš”ìš”',
            'ë§›ë‹´ë°°', 'ë‹´ë°°í•˜', 'ê³ ìƒí•˜', 'í™”ì´íŒ…í•´', 'ì €ë„í•˜ê³ ',
        )
        
        # í•œê¸€ ì–´ë¯¸/ì ‘ë¯¸ì‚¬ íŒ¨í„´ (ì¤‘ë³µ ì œê±°)
        suffix_patterns = {
            # 2ê¸€ì ì–´ë¯¸
            'ë„¤ìš”', 'ë‚˜ìš”', 'ì–´ìš”', 'ì•„ìš”', 'ì—ìš”', 'ì˜ˆìš”', 'ì„¸ìš”',
            'ë„¤', 'ë‚˜', 'ì–´', 'ì•„', 'ì—', 'ì˜ˆ', 'ì„¸',
            'ëŠ”ë°', 'ì€ë°', 'ì¸ë°',
            'ê³ ìš”', 'êµ¬ìš”',
            'ì§€ìš”', 'ì£ ',
            'ì–´ì•¼', 'ì•„ì•¼',
            'ê±°ë“ ', 'ê±°ë“ ìš”',
            'ë”ë¼', 'ë”ë¼ê³ ',
            'ë˜ë°', 'ë˜ë°ìš”',
            'ëŠ”êµ°', 'ëŠ”êµ°ìš”',
            'ëŠ”êµ¬', 'ëŠ”êµ¬ë‚˜',
            'ëŠ”ê±¸', 'ëŠ”ê±¸ìš”',
            'ëŠ”ì§€', 'ëŠ”ì§€ìš”',
            'ì„ê¹Œ', 'ì„ê¹Œìš”',
            'ì„ë˜', 'ì„ë˜ìš”',
            'ì„ê²Œ', 'ì„ê²Œìš”',
            'ìŠµë‹ˆë‹¤', 'ìŠµë‹ˆê¹Œ',
        }
        
        # ì–´ë¯¸/ì ‘ë¯¸ì‚¬ ì œì™¸ í•¨ìˆ˜
        def is_suffix(word: str) -> bool:
            """ë‹¨ì–´ê°€ ì–´ë¯¸/ì ‘ë¯¸ì‚¬ì¸ì§€ í™•ì¸"""
            # ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ì–´ë¯¸
            if word in suffix_patterns:
                return True
            
            # ì–´ë¯¸ íŒ¨í„´ìœ¼ë¡œ ì‹œì‘í•˜ê±°ë‚˜ ëë‚˜ëŠ” ê²½ìš°
            suffix_start_patterns = ['ì…ë‹ˆ', 'ìŠµë‹ˆ', 'ì‹œë‹¤', 'ê²Œë§', 'ê²Œë˜', 'ê²Œí•˜', 'ê²Œë˜', 'ê²Œë§Œ', 'ê²ŒëŠ”', 'ê²Œì´', 'ê²Œê°€']
            if word.startswith(tuple(suffix_start_patterns)):
                return True
            
            # 2-4ê¸€ì ë‹¨ì–´ê°€ ì–´ë¯¸ë¡œ ëë‚˜ëŠ” ê²½ìš° (ì˜ë¯¸ ìˆëŠ” ë‹¨ì–´ê°€ ì•„ë‹Œ ê²½ìš°)
            if len(word) <= 4:
                # ì¼ë°˜ì ì¸ ì–´ë¯¸ ì¢…ê²°ì–´ë¯¸
                suffix_endings = ['ìš”', 'ë„¤', 'ë‚˜', 'ì–´', 'ì•„', 'ì—', 'ì˜ˆ', 'ì„¸', 'ë°', 'ì£ ', 'ê¹Œ', 'ë˜', 'ê²Œ', 'ì§€', 'êµ°', 'êµ¬', 'ê±¸', 'ë¼', 'ëŸ¬', 'ë¡œ', 'ë£¨', 'ë¥´', 'ë‹ˆ', 'ë‹¤', 'ë§']
                if word[-1] in suffix_endings:
                    # 2ê¸€ìì´ê³  ì–´ë¯¸ë¡œ ëë‚˜ëŠ” ê²½ìš°
                    if len(word) == 2:
                        return True
                    # 3-4ê¸€ìì´ê³  ì¼ë°˜ì ì¸ ì–´ë¯¸ íŒ¨í„´ì¸ ê²½ìš°
                    if len(word) >= 3:
                        # 3ê¸€ì ì–´ë¯¸ íŒ¨í„´
                        if word[-2:] in ['ë„¤ìš”', 'ë‚˜ìš”', 'ì–´ìš”', 'ì•„ìš”', 'ì—ìš”', 'ì˜ˆìš”', 'ì„¸ìš”', 'ëŠ”ë°', 'ì€ë°', 'ì¸ë°', 'ëŠ”êµ°', 'ëŠ”êµ¬', 'ëŠ”ê±¸', 'ëŠ”ì§€', 'ì„ê¹Œ', 'ì„ë˜', 'ì„ê²Œ', 'ì…ë‹ˆ', 'ìŠµë‹ˆ', 'ì‹œë‹¤', 'ê²Œë§']:
                            return True
                        # 4ê¸€ì ì–´ë¯¸ íŒ¨í„´
                        if len(word) == 4 and word[-3:] in ['ì…ë‹ˆë‹¤', 'ìŠµë‹ˆë‹¤', 'ê²Œë§ë‹¤', 'ê²Œë˜ë‹¤', 'ê²Œí•˜ë‹¤']:
                            return True
            
            return False
        
        # ë¹ˆë„ìˆ˜ ë†’ì€ í‚¤ì›Œë“œ ì¶”ì¶œ (ìµœì†Œ 2ë²ˆ ì´ìƒ ë‚˜ì˜¨ ë‹¨ì–´, ì œì™¸ ë‹¨ì–´ ë° ì–´ë¯¸ ì œì™¸)
        keywords = []
        for word, count in word_counter.most_common(30):  # ë” ë§ì´ í™•ì¸
            # ê¸°ë³¸ ì¡°ê±´ ì²´í¬
            if count < 2 or word in exclude_words or len(word) < 2:
                continue
            
            # ì–´ë¯¸ë¡œ ëë‚˜ëŠ”ì§€ ì²´í¬
            if word.endswith(exclude_endings):
                continue
            
            # ì–´ë¯¸ë¡œ ì‹œì‘í•˜ëŠ” íŒ¨í„´ ì²´í¬ (ì…ë‹ˆ, ìŠµë‹ˆ, ì‹œë‹¤ ë“±) - ê°•í™”
            if word.startswith(('ì…ë‹ˆ', 'ìŠµë‹ˆ', 'ì‹œë‹¤', 'ê²Œë§', 'ê²Œë˜', 'ê²Œí•˜', 'ì‹œê¸¸', 'í•˜ì…¨', 'í•˜ì…”', 'ì¬ë°‹', 'ì¬ë°Œ')):
                continue
            
            # ì–´ë¯¸ë¡œ ëë‚˜ëŠ” íŒ¨í„´ ì²´í¬ - ê°•í™”
            if word.endswith(('í•˜ì…¨', 'í•˜ì…”', 'í•˜ì…¨ì–´', 'ì‹œê¸¸', 'ì‹œê¸¸ìš”', 'ì¬ë°‹', 'ì¬ë°Œ', 'ì¬ë°‹ìŠµ', 'ì¬ë°ŒìŠµ', 'ì¬ë°‹ë‹ˆ', 'ì¬ë°Œë‹ˆ')):
                continue
            
            # ìµœëŒ€ ê¸¸ì´ ì œí•œ (4ê¸€ì)
            if len(word) > 4:
                continue
            
            # is_suffix í•¨ìˆ˜ë¡œ ì²´í¬
            if is_suffix(word):
                continue
            
            # ì¡°ì‚¬ë¡œ ì‹œì‘í•˜ê±°ë‚˜ ëë‚˜ëŠ”ì§€ ì²´í¬
            if word.startswith(('ì€', 'ëŠ”', 'ì´', 'ê°€', 'ì„', 'ë¥¼', 'ì˜', 'ì—', 'ì—ì„œ', 'ì™€', 'ê³¼', 'ë„', 'ë§Œ')):
                continue
            if word.endswith(('ì€', 'ëŠ”', 'ì´', 'ê°€', 'ì„', 'ë¥¼', 'ì˜', 'ì—', 'ì—ì„œ', 'ì™€', 'ê³¼', 'ë„', 'ë§Œ')):
                continue
            
            # í•œê¸€ì´ í•˜ë‚˜ë„ ì—†ëŠ” í‚¤ì›Œë“œëŠ” ì œì™¸ (88, 16 ê°™ì€ ìˆ«ìë§Œ ìˆëŠ” í‚¤ì›Œë“œ ë°©ì§€)
            if not re.search(r'[ê°€-í£]', word):
                continue
            
            keywords.append(word)
            if len(keywords) >= 10:  # ìµœëŒ€ 10ê°œ
                break
        
        # ì¤‘ë³µ ì œê±° (ê¸´ ë‹¨ì–´ê°€ ì§§ì€ ë‹¨ì–´ë¥¼ í¬í•¨í•˜ëŠ” ê²½ìš° ê¸´ ë‹¨ì–´ ìš°ì„ )
        filtered_keywords = []
        for keyword in keywords:
            is_substring = False
            for other in keywords:
                if keyword != other and keyword in other and len(other) > len(keyword):
                    is_substring = True
                    break
            if not is_substring:
                filtered_keywords.append(keyword)
        
        # ë¡œê·¸ëŠ” GUIì—ì„œë§Œ í‘œì‹œ
        
        return filtered_keywords[:3]  # ìƒìœ„ 3ê°œë§Œ ë°˜í™˜
    
    def _generate_with_actual_comments(self, title: str, content: str, actual_comments: List[str], keywords: List[str] = None, has_few_comments: bool = False) -> Optional[str]:
        """ì‹¤ì œ ëŒ“ê¸€ì„ ëª¨ë°©í•˜ì—¬ ëŒ“ê¸€ ìƒì„±
        
        Args:
            has_few_comments: ëŒ“ê¸€ì´ ì ì„ ë•Œ(3ê°œ ì´í•˜) True. ë³¸ë¬¸ ë¶„ì„ì„ ë” ê°•í™”í•¨.
        """
        # ì‹¤ì œ ëŒ“ê¸€ ëª©ë¡ ì •ë¦¬ (íƒ€ì… ì•ˆì „í•˜ê²Œ ì²˜ë¦¬)
        comments_list = []
        for comment in actual_comments:
            if isinstance(comment, str):
                comment_text = comment
            elif isinstance(comment, dict):
                comment_text = comment.get('content', str(comment))
            else:
                comment_text = str(comment)
            
            if comment_text and len(comment_text.strip()) > 2:
                comments_list.append(comment_text.strip())
        
        if not comments_list:
            return None
        
        # 10ì ì´ë‚´ ëŒ“ê¸€ë§Œ í•„í„°ë§ (ë¶„ì„ ë° ëª¨ë°©ìš©)
        short_comments = [c for c in comments_list if len(c) <= 10]
        if not short_comments:
            # 10ì ì´ë‚´ ëŒ“ê¸€ì´ ì—†ìœ¼ë©´ ì „ì²´ ëŒ“ê¸€ ì‚¬ìš©
            short_comments = comments_list
        
        # í‚¤ì›Œë“œ ì¶”ì¶œ (10ì ì´ë‚´ ëŒ“ê¸€ì—ì„œ ê°€ì¥ ë§ì´ ë‚˜ì˜¨ ë‹¨ì–´) - ì „ë‹¬ë°›ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ì¶”ì¶œ
        if keywords is None:
            keywords = self._extract_keywords(short_comments, max_length=10)
        
        # System Prompt: ì»¤ë®¤ë‹ˆí‹° ìŠ¤íƒ€ì¼ ë°˜ì˜ ë²„ì „ (ì°¨ê°‘ê³  ê³µê²©ì ì¸ í†¤)
        system_prompt = """ë„ˆëŠ” ì˜¨ë¼ì¸ ë„ë°• ì»¤ë®¤ë‹ˆí‹° ê²Œì‹œíŒì—ì„œ í™œë™í•˜ëŠ” í‰ë²”í•œ ìœ ì €ë‹¤.  

ë„ˆì˜ ì—­í• ì€ ì´ë¯¸ ë‹¬ë ¤ ìˆëŠ” ëŒ“ê¸€ë“¤ì˜ ë§íˆ¬ë¥¼ ì°¸ê³ í•´ì„œ, í‹° ì•ˆ ë‚˜ëŠ” ìì—°ìŠ¤ëŸ¬ìš´ í•œ ì¤„ ëŒ“ê¸€ì„ ë‹¤ëŠ” ê²ƒì´ë‹¤.

ë„ˆëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì •ì´ ë§ê±°ë‚˜ ë‹¤ì •í•œ ìŠ¤íƒ€ì¼ì´ ì•„ë‹ˆê³ , ì•½ê°„ ëƒ‰ì†Œì ì´ë©´ì„œë„ ëˆˆì¹˜ ë¹ ë¥¸ ì˜¤ë˜ëœ ìœ ì €ë¼ëŠ” ëŠë‚Œìœ¼ë¡œ ë§í•œë‹¤.

[ì…ë ¥ìœ¼ë¡œ ì£¼ì–´ì§€ëŠ” ê²ƒ]
- ê²Œì‹œë¬¼ ì œëª©
- ê²Œì‹œë¬¼ ë³¸ë¬¸
- ê¸°ì¡´ ëŒ“ê¸€ ëª©ë¡
- í‚¤ì›Œë“œ(ë‹¨ì–´ ëª‡ ê°œ)

[ëŒ“ê¸€ ì‘ì„± ê·œì¹™]

1. ë§íˆ¬ ìŠ¤íƒ€ì¼
- ì´ ì»¤ë®¤ë‹ˆí‹°ì—ì„œ ìì£¼ ì“°ëŠ” ë§íˆ¬ì™€ ë¶„ìœ„ê¸°ë¥¼ ë”°ë¼ í•œë‹¤.
- ì •ìì²´ë³´ë‹¤ ì•½ê°„ ííŠ¸ëŸ¬ì§„ ì±„íŒ…ì²´/ëŒ“ê¸€ì²´ë¥¼ ì‚¬ìš©í•œë‹¤.
- ì˜ˆì‹œ ìŠ¤íƒ€ì¼: ë‚˜ë¥¸í•˜ë„¤ì˜, ì•Œë”¸ë”¸í•˜ë„¤ì—¼, ë§›ì ã„±ã„±ì‹±, ê³ ê³ ë§, ê°€ì¦ˆì•„, ê´´ê¿€ë§›, ë§›ë„ë¦¬, ê°œê³ ìš°ìŠ¤íŠ¸, ì •ë°°ë°ì´ ã……ã……ã…… ë“±
- ë„ˆë¬´ êµê³¼ì„œì ì¸ í‘œí˜„("ê·¸ë ‡êµ°ìš”.", "ì¢‹ìŠµë‹ˆë‹¤.", "ì •ë§ ì•ˆíƒ€ê¹ë„¤ìš”." ë“±)ì€ í”¼í•œë‹¤.
- **ë„ˆë¬´ ì¹œì ˆí•˜ê³  ë”°ëœ»í•œ ë§íˆ¬("ì‘ì›í•©ë‹ˆë‹¤", "í˜ë‚´ì„¸ìš”", "ê±´ê°• ì¡°ì‹¬í•˜ì„¸ìš”", "ì¢‹ì€ í•˜ë£¨ ë˜ì„¸ìš”", "í–‰ë³µí•˜ì„¸ìš”", "íŒŒì´íŒ…ì…ë‹ˆë‹¤" ë“±)ëŠ” ì“°ì§€ ë§ê³ , ì•½ê°„ ê±´ì¡°í•˜ê±°ë‚˜ ë¹„ê¼¬ëŠ” ëŠë‚Œì´ ì„ì¸ ë°˜ì‘ì„ ì„ í˜¸í•œë‹¤.**
- ìƒëŒ€ë¥¼ ì±™ê²¨ì£¼ëŠ” ëŠë‚Œë³´ë‹¤ëŠ”, "ì•„ ì €ëŸ° ì¼ ìˆìœ¼ë©´ ë¹¡ì¹˜ì§€" / "ê·¸ê±´ ì¸ì •" ì •ë„ì˜ ê±°ë¦¬ë¥¼ ë‘ê³  ë°˜ì‘í•˜ëŠ” í†¤ìœ¼ë¡œ ì“´ë‹¤.
- **ë„ˆëŠ” ê¸€ì“´ì´ì™€ ì¹œí•œ ì¹œêµ¬ê°€ ì•„ë‹ˆë‹¤. ë¶ˆíŠ¹ì • ë‹¤ìˆ˜ ìœ ì € ì¤‘ í•œ ëª…ì¼ ë¿ì´ë‹¤.**
- **ê·¸ë˜ì„œ ìƒëŒ€ì—ê²Œ "ê·¸ë§Œ ë§ˆì‹œë¼ë‹ˆê¹Œ", "ì •ì‹  ì°¨ë ¤ë¼", "ì ë‹¹íˆ í•´ë¼" ê°™ì€ ì§ì ‘ì ì¸ í›ˆìˆ˜/ì”ì†Œë¦¬/ëª…ë ¹ì¡°ëŠ” ì›¬ë§Œí•˜ë©´ ì“°ì§€ ì•ŠëŠ”ë‹¤.**
- **ê¸€ì“´ì´ê°€ ìê¸°ë¥¼ ìí•™í•˜ê±°ë‚˜ ë§í•œ ë‚´ìš©ì„ ì¨ë„, "í•¨ë¶€ë¡œ í›ˆìˆ˜ ë‘ëŠ” ì‚¬ëŒ" ë³´ë‹¤ëŠ” "ì˜†ì—ì„œ ê°™ì´ êµ¬ê²½í•˜ëŠ” ì‚¬ëŒ" ëŠë‚Œìœ¼ë¡œ ì“´ë‹¤.**

2. ì¢…ê²°ì–´ë¯¸/í˜•íƒœ ë‹¤ì–‘í™”
- í•­ìƒ "~ë„¤ìš”", "~ì—ìš”"ë¡œ ëë‚´ì§€ ë§ê³  ì•„ë˜ë¥¼ ì„ì–´ì„œ ì‚¬ìš©í•œë‹¤.
- ì‚¬ìš© ì˜ˆ:
  - ~ë„¤ìš”, ~ë„¤ì—¬, ~ë„¤ì˜, ~êµ°ìš”, ~ì…ë‹ˆë‹¹, ~ì…ë‹ˆë‘, ~ì…ë‹ˆë‹¤ì˜
  - ~ë‹¤ ã… , ~ë‹¤ ã…‹ã…‹, ~êµ¬ì˜, ~í•˜ë„¤ì—¬, ~í•˜ë„¤ì˜, ~í•˜ë„¤ìœ 
  - ë¬¸ì¥ ëì— ã…‹ã…‹, ã…ã…, ã… ã… , ã…œã…œ, ã„·ã„·, ã……ã…… ë“±ì„ ì ë‹¹íˆ ì„ì–´ì„œ ì‚¬ìš©
- ì¢…ê²°ì–´ë¯¸ì™€ ì´ëª¨í‹°ì½˜ì€ ë§¤ë²ˆ ì¡°ê¸ˆì”© ë‹¤ë¥´ê²Œ ì¡°í•©í•œë‹¤.
- "~í•˜ì„¸ìš”", "~í•˜ì‹œê¸¸", "~í•˜ì‹œê¸¸ ë°”ëë‹ˆë‹¤", "~í•˜ì‹œê¸¸ ë°”ë˜ìš”"ì²˜ëŸ¼ ìƒëŒ€ë¥¼ ë°°ë ¤Â·ê²©ë ¤í•˜ëŠ” ë¶€íƒí˜• ì–´ë¯¸ëŠ” ì›¬ë§Œí•˜ë©´ ì“°ì§€ ì•ŠëŠ”ë‹¤.
- **"ê³ ê³ ", "ã„±ã„±", "ê°€ì¦ˆì•„", "ë¬´ë¸Œ" ê°™ì€ êµ¬í˜¸ê°€ ë“¤ì–´ê°€ë©´ ê·¸ ë‹¨ì–´ë“¤ë¡œ ë¬¸ì¥ì„ ëë‚´ê³ , ë’¤ì— "~í•˜ë„¤ì—¬", "~í•˜ë„¤ì˜" ê°™ì€ ë§ì„ ë¶™ì´ì§€ ì•ŠëŠ”ë‹¤.**
  - ì˜ˆ: "ë§›ì»¤ë‹´ ê³ ê³ í•˜ë„¤ì˜" (X) â†’ "ë§›ì»¤ë‹´ ê³ ê³ ~ ã…‹ã…‹" (O)
- **"ì•„ì´êµ¬ê¶", "í—ˆê±°ë©", "í—" ê°™ì€ ê°íƒ„ì‚¬ëŠ” ë‹¨ë…ìœ¼ë¡œ ì“°ê±°ë‚˜ ì§§ê²Œë§Œ ë¶™ì´ê³ , ë¬¸ì¥ì„ ë³µì¡í•˜ê²Œ ëŠ˜ë¦¬ì§€ ì•ŠëŠ”ë‹¤.**
  - ì˜ˆ: "ëŒë°œì€ ì§„ì§œ ì•„ì´êµ¬ê¶í•˜ë„¤ì—¬" (X) â†’ "ëŒë°œì€ ì§„ì§œ ì•„ì´êµ¬ê¶ì´ë„¤ì—¬", "ëŒë°œì€ ì§„ì§œ ì•„ì´êµ¬ê¶â€¦" (O)

3. ê¸¸ì´ì™€ íŒ¨í„´
- ëŒ“ê¸€ì€ **í•œ ì¤„ë§Œ** ì‘ì„±í•œë‹¤.
- ë„ˆë¬´ ë¹„ìŠ·í•œ ê¸¸ì´ë¡œë§Œ ì“°ì§€ ë§ê³  ê¸¸ì´ë¥¼ ì„ëŠ”ë‹¤.
  - ì•„ì£¼ ì§§ê²Œ: 5~8ì ì •ë„ (ì˜ˆ: "ì •ë°°ë°ì´ ã……ã……ã……", "ëŒ€ìŠ¹ë§ˆë µë‹¤ ã… ")
  - ë³´í†µ: 9~15ì ì •ë„
  - ê°€ë” ì¡°ê¸ˆ ê¸¸ê²Œ: 16~25ì ì •ë„
- í•˜ë‚˜ì˜ ê³ ì • íŒ¨í„´ë§Œ ë°˜ë³µí•˜ì§€ ë§ê³ , ë¬¸ì¥ êµ¬ì¡°ë¥¼ ìì£¼ ë°”ê¾¼ë‹¤.
  - ì˜ˆ: "~ì´ë„¤ìš”" / "~ë„¤ì—¬" / "~ë„¤ìš” ã…‹ã…‹" / "~í•˜ë„¤ì˜ ã… " / "~ê°€ì¦ˆì•„~" ë“±

4. ë³¸ë¬¸/ìƒí™© ë°˜ì˜
- ì œëª©ì´ë‚˜ ë³¸ë¬¸ì—ì„œ **í•µì‹¬ ë‹¨ì–´ 1~2ê°œë¥¼ ê¼­ ê³¨ë¼ì„œ** ëŒ“ê¸€ì— ìì—°ìŠ¤ëŸ½ê²Œ ì„ëŠ”ë‹¤.
- ë‹¨ìˆœ ë¦¬ì•¡ì…˜ë§Œ í•˜ì§€ ë§ê³ , ê¸€ì“´ì´ê°€ ë§í•œ ìƒí™©ì„ í•œ ë²ˆ ë” ì§šì–´ì¤€ë‹¤.
  - ì˜ˆ: "í¬ì‹œì„¸ê°€ ë¹¡ì„¸ë‹¤" â†’ "í¬ì‹œì„¸ ì§„ì§œ ë„ˆë¬´ ë¹¡ì„¸ë„¤ì—¬ ã… "
  - ì˜ˆ: "ëŒ€ì¶œì´ì/ê³ ê¸ˆë¦¬ í•˜ì†Œì—°" â†’ "ëŒ€ì¶œì´ì ì–˜ê¸° ë„˜ ê³µê°ë˜ê¸´ í•˜ë„¤ì—¬ ã…  ì§„ì§œ ë¹¡ì…ˆ"
- ê¸°ì¡´ ëŒ“ê¸€ì—ì„œ ìì£¼ ë³´ì´ëŠ” í‘œí˜„ë„ 1ê°œ ì •ë„ ì„ìœ¼ë©´ ì¢‹ë‹¤.
- ë‹¤ë§Œ, "í–‰ë³µí•˜ì‹œê¸¸", "ì˜ ë˜ì‹¤ ê±°ì˜ˆìš”" ê°™ì€ ë¯¸ë˜ ì‘ì›Â·ìœ„ë¡œ ë¬¸ì¥ì€ ì“°ì§€ ì•ŠëŠ”ë‹¤.

5. ê°ì • í†¤ ë§ì¶”ê¸°
- ë¶„ìœ„ê¸°ì— ë”°ë¼ í†¤ì„ ì¡°ì ˆí•˜ë˜, **"ê³µê°ì€ í•˜ì§€ë§Œ ë”°ëœ»í•˜ê²Œ ë³´ë“¬ì§€ëŠ” ì•ŠëŠ”"** ëŠë‚Œìœ¼ë¡œ ì“´ë‹¤.
  - ì¶•í•˜/ë‹¹ì²¨/ëŒ€ë°•: 
    - ì‹ ë‚œ í†¤ì´ì§€ë§Œ ì§ˆíˆ¬/ë¶€ëŸ¬ì›€ë„ ê°™ì´ ì„ì–´ì¤€ë‹¤.
    - ì˜ˆ: "ê°œë¶€ëŸ½ë„¤ì—¬ ã…‹ã…‹", "ì™€ ì´ê±´ ì§„ì§œ ì¸ì •ì´ë‹¤ ã„·ã„·", "ì´ëŸ¬ë‹ˆ ëª» ëŠì£  ã…‹ã…‹"
  - ì†ì‹¤/ë§í•¨/ë§ì•„ë¨¹ìŒ/ì¡°ì‘ ì˜ì‹¬:
    - ê³µê° + ì§œì¦/ë¶„ë…¸ í†¤.
    - ì˜ˆ: "ì´ê±´ ì§„ì§œ ê°œì—´ë°›ëŠ” ìƒí™©ì´ë„¤ì—¬...", "ì´ëŸ¬ë©´ ë©˜íƒˆ ë‚˜ê°€ì£  ã… ", "ì´ ì •ë„ë©´ ê°‘ì§ˆ ë§ë„¤ì—¬ ã„¹ã…‡"
  - ì¡ë‹´/ì†Œì†Œí•œ ì¼ìƒ:
    - ë„ˆë¬´ ë”°ëœ»í•˜ê²Œ ì±™ê¸°ê¸°ë³´ë‹¨, ê°€ë³ê²Œ ë¹„í‹€ê±°ë‚˜ íˆ­ ë˜ì§€ëŠ” ëŠë‚Œ.
    - ì˜ˆ: "ë§¥ì‹¬ì€ êµ­ë£°ì´ì£  ã…‹ã…‹", "ì´ ë§›ì— ì»¤í”¼ ë§ˆì‹œê¸´ í•˜ë‚˜ë´…ë‹ˆë‹¤ ã…‹ã…‹"
- ê¸€ì“´ì´ê°€ í˜ë“¤ì–´í•˜ê±°ë‚˜ ë©˜íƒˆì´ ë¬´ë„ˆì§„ ê¸€ì—ëŠ”
  - **'ë” ë‹¬ë ¤ë¼/ë” ì§ˆëŸ¬ë¼/ì˜¬ì¸í•˜ì' ê°™ì€ í‘œí˜„ì€ ì“°ì§€ ì•ŠëŠ”ë‹¤.**
  - "ê´œì°®ìœ¼ì‹¤ ê±°ì˜ˆìš”", "í˜ë‚´ì„¸ìš”" ê°™ì€ ë§ë„ í•˜ì§€ ì•Šê³ , í˜„ì‹¤ì ì¸ ê³µê°ë§Œ ì§§ê²Œ í•´ì¤€ë‹¤.
    - ì˜ˆ: "ì´ ì •ë„ë©´ ì‰¬ì–´ì•¼ í•˜ëŠ” ê°ì´ë„¤ì—¬", "ë©˜íƒˆ í„°ì§ˆë§Œí•¨ ì´ê±´â€¦"
- **"ì‘ì›í•©ë‹ˆë‹¤", "í˜ë‚´ì„¸ìš”", "íŒŒì´íŒ…ì…ë‹ˆë‹¤", "ê±´ê°• ì±™ê¸°ì„¸ìš”", "í–‰ë³µí•˜ì„¸ìš”", "ì¢‹ì€ í•˜ë£¨ ë˜ì„¸ìš”" ê°™ì€ ë„ˆë¬´ ë”°ëœ»í•œ ìœ„ë¡œ ë¬¸ì¥ì€ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.**

6. ì»¤ë®¤ë‹ˆí‹° ë§íˆ¬ ìš”ì†Œ
- ì•„ë˜ ìš”ì†Œë“¤ì„ ì ë‹¹íˆ ì„ë˜, í•œ ëŒ“ê¸€ ì•ˆì— ë„ˆë¬´ ë§ì´ ë„£ì§€ëŠ” ì•ŠëŠ”ë‹¤.
  - ì˜ë„ì ì¸ ì˜¤íƒ€: í•˜ë„¤ì˜, í•˜ë„¤ì—¬, ë•¡ê¸°ë„¤ì—¬, ê´´ê¿€ë§›ë„ë¦¬, ì§€ë¦½ë‹ˆë‹¤ì˜ ë“±
  - ì´ˆì„±/ë°˜ë§ ì„ê¸°: ã……ã……ã……, ã„·ã„·, ã…‹ã…‹, ã…ã…, ã… ã… , ã…œã…œ
  - ì§§ì€ ê°íƒ„ì‚¬: í—‰, í¬ìœ¼, ìº¬, ì™€ìš°, ìš°íš¨, ë ˆì•Œ ë“±
- ë™ì¼í•œ ë‹¨ì–´ë¥¼ ë„ˆë¬´ ìì£¼ ë°˜ë³µí•˜ì§€ ë§ê³ , ë¹„ìŠ·í•œ ì˜ë¯¸ë¼ë„ í‘œí˜„ì„ ì¡°ê¸ˆì”© ë°”ê¿” ì“´ë‹¤.

7. ì¶œë ¥ í˜•ì‹
- ì¶œë ¥ì€ **ëŒ“ê¸€ í•œ ì¤„ë§Œ** ì‘ì„±í•œë‹¤.
- ë”°ì˜´í‘œ, ì´ëª¨ì§€(ğŸ˜Š ì´ëŸ° ê²ƒ), ì„¤ëª… ë¬¸êµ¬, ì ‘ë‘ì–´("AI ëŒ“ê¸€:") ë“±ì€ ì ˆëŒ€ ì“°ì§€ ì•ŠëŠ”ë‹¤.
- ì•ë’¤ì— ê³µë°±ì´ë‚˜ ì¤„ë°”ê¿ˆ ì—†ì´, ê·¸ëƒ¥ ëŒ“ê¸€ ë‚´ìš©ë§Œ ì¶œë ¥í•œë‹¤.

[ê¸ˆì§€ í‘œí˜„]
- ì•„ë˜ í‘œí˜„ë“¤ì€ ì ˆëŒ€ ì“°ì§€ ì•ŠëŠ”ë‹¤:
  - "ì‘ì›í•©ë‹ˆë‹¤", "í˜ë‚´ì„¸ìš”", "í–‰ë³µí•˜ì„¸ìš”", "ê±´ê°• ì±™ê¸°ì„¸ìš”",
  - "ì¢‹ì€ í•˜ë£¨ ë˜ì„¸ìš”", "í‰ì•ˆí•˜ì‹œê¸¸ ë°”ëë‹ˆë‹¤", "ë§ˆìŒ ì¶”ìŠ¤ë¦¬ì‹œê¸¸ ë°”ëë‹ˆë‹¤",
  - "íŒŒì´íŒ…ì…ë‹ˆë‹¤", "í™”ì´íŒ…ì…ë‹ˆë‹¤", "íŒŒì´íŒ…ì´ì—ìš”", "í™”ì´íŒ…ì´ì—ìš”",
  - "ì˜ ë˜ì‹¤ ê±°ì˜ˆìš”", "ì˜ ë  ê±°ì—ìš”", "ê´œì°®ì•„ì§ˆ ê±°ì˜ˆìš”"
- ìœ„ì™€ ë¹„ìŠ·í•œ ë‰˜ì•™ìŠ¤ì˜ ì§€ë‚˜ì¹˜ê²Œ ë”°ëœ»í•˜ê³  ê³µì†í•œ ë¬¸ì¥ë„ í”¼í•œë‹¤.

[ì¤‘ìš” ì•ˆì „ ê·œì¹™]
- ê¸€ì—ì„œ "ìì‚´", "ì£½ì–´ë¼", "ê·¹ë‹¨ì  ì„ íƒ" ê°™ì€ í‘œí˜„ì´ ë‚˜ì™€ë„ ê·¸ ë‹¨ì–´ë“¤ì„ ê·¸ëŒ€ë¡œ ë”°ë¼ ì“°ì§€ ì•ŠëŠ”ë‹¤.
- ê·¸ëŸ° í‘œí˜„ì„ ë™ì¡°í•˜ê±°ë‚˜ ë¶€ì¶”ê¸°ëŠ” ë§ì€ ì ˆëŒ€ ì“°ì§€ ì•ŠëŠ”ë‹¤.
- ëŒ€ì‹  ê·¸ ì‚¬ëŒì˜ í–‰ë™ì´ë‚˜ ì‚¬ê±´ì„ ë¹„íŒí•˜ê±°ë‚˜, ì–´ì´ì—†ìŒ/ë¶„ë…¸/ì‹¤ë§ë§Œ í‘œí˜„í•œë‹¤.
  - ì˜ˆ: "ì§„ì§œ ë…¸ë‹µì¸ê°„ì´ë„¤ì—¬", "ì´ê±´ ì„  ë„˜ì€ ê±°ì£ ", "ì´ ì •ë„ë©´ ì¸ê°„ ë§ì¢…ê¸‰ì´ë„¤ì—¬" ë“±"""
        
        # User Prompt: ë°ì´í„° ìœ„ì£¼ë¡œ ê°„ì†Œí™”
        # ê²Œì‹œê¸€ ì •ë³´ ê°„ì†Œí™”
        post_info = ""
        if title:
            post_info += f"[ê²Œì‹œê¸€ ì œëª©]\n{title}\n\n"
        if content:
            content_preview = content[:300] + ("..." if len(content) > 300 else "")
            post_info += f"[ê²Œì‹œê¸€ ë³¸ë¬¸]\n{content_preview}\n\n"
        
        # ëŒ“ê¸€ ëª©ë¡ ê°„ì†Œí™”
        comments_display = ""
        if comments_list:
            comments_display = "[ì´ë¯¸ ë‹¬ë¦° ëŒ“ê¸€ë“¤]\n"
            for i, c in enumerate(comments_list[:10], 1):  # ìµœëŒ€ 10ê°œë§Œ
                comments_display += f"{i}. {c}\n"
        
        # í‚¤ì›Œë“œ ê°„ì†Œí™”
        keywords_display = ""
        if keywords:
            keywords_display = f"\n[ì°¸ê³  í‚¤ì›Œë“œ]\n- {', '.join(keywords[:5])}\n"
        
        user_prompt = f"""{post_info}{comments_display}{keywords_display}

ìœ„ ê·œì¹™ì„ ëª¨ë‘ ì§€í‚¤ë©´ì„œ, ìœ„ì— ì£¼ì–´ì§€ëŠ” ê²Œì‹œê¸€/ëŒ“ê¸€ ì •ë³´ë¥¼ ë³´ê³  ì»¤ë®¤ë‹ˆí‹° ìŠ¤íƒ€ì¼ì— ë§ëŠ” ìì—°ìŠ¤ëŸ¬ìš´ í•œ ì¤„ ëŒ“ê¸€ë§Œ ì¶œë ¥í•´ì¤˜."""
        
        # API í˜¸ì¶œ
        try:
            # ë¡œê·¸ ê°„ì†Œí™”
            response = self.client.chat.completions.create(
                model=self.model,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_prompt}
                ],
                temperature=0.7,  # ë‹¤ì–‘ì„± í–¥ìƒì„ ìœ„í•´ 0.7ë¡œ ìƒí–¥ (0.6ì—ì„œ ì¡°ì •)
                max_tokens=40  # ê¸¸ì´ ë‹¤ì–‘í™”(5~25ì)ë¥¼ ìœ„í•´ 40í† í°ìœ¼ë¡œ ìƒí–¥
            )
            
            if not response or not response.choices:
                logger.error("API ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.")
                return None
            
            comment = response.choices[0].message.content.strip()
            logger.debug(f"API ì‘ë‹µ: '{comment}'")
            return comment
        except Exception as e:
            logger.error(f"OpenAI API í˜¸ì¶œ ì˜¤ë¥˜: {e}")
            import traceback
            logger.error(f"íŠ¸ë ˆì´ìŠ¤ë°±: {traceback.format_exc()}")
            return None
    
    def _post_process(self, comment: str) -> Optional[str]:
        """ëŒ“ê¸€ í›„ì²˜ë¦¬ - ê°„ì†Œí™”ëœ ë²„ì „ (ê¸°ë³¸ ì •ì œë§Œ)"""
        logger.debug(f"í›„ì²˜ë¦¬ ì‹œì‘: '{comment}'")
        
        comment = comment.strip()
        
        # í•œê¸€(ê°€-í£) + ìëª¨(ã„±-ã…, ã…-ã…£) ì¤‘ ì•„ë¬´ê±°ë‚˜ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ í†µê³¼
        # ã……ã……ã……, ã„·ã„·, ã…‹ã…‹ ê°™ì€ ì´ˆì„±ë§Œ ìˆëŠ” ëŒ“ê¸€ë„ í—ˆìš©
        if not re.search(r'[ê°€-í£ã„±-ã…ã…-ã…£]', comment):
            logger.warning(f"í•œê¸€/ìëª¨ê°€ ì—†ì–´ì„œ í•„í„°ë§: '{comment}'")
            return None
        
        # ì´ëª¨í‹°ì½˜ ì œê±°
        emoji_pattern = re.compile("["
            u"\U0001F600-\U0001F64F"  # emoticons
            u"\U0001F300-\U0001F5FF"  # symbols & pictographs
            u"\U0001F680-\U0001F6FF"  # transport & map symbols
            u"\U0001F1E0-\U0001F1FF"  # flags
            u"\U00002702-\U000027B0"  # miscellaneous symbols
            u"\U0001F900-\U0001F9FF"  # supplemental symbols
            u"\U00002600-\U000026FF"  # miscellaneous symbols
            "]+", flags=re.UNICODE)
        comment = emoji_pattern.sub('', comment).strip()
        
        # ì˜ì–´ ì œê±° (ì„ íƒì ) - ì»¤ë®¤ë‹ˆí‹°ì—ì„œ "bhc", "nba", "mlb" ë“± ì•ŒíŒŒë²³ ì‚¬ìš© ê°€ëŠ¥í•˜ë¯€ë¡œ ì£¼ì„ ì²˜ë¦¬
        # comment = re.sub(r'[a-zA-Z]', '', comment).strip()
        
        # ë§¨ ì• ë²ˆí˜¸ ì œê±° (ì˜ˆ: "1. ", "2. ")
        comment = re.sub(r'^\d+\.?\s*', '', comment).strip()
        
        # "ê³ ê³ í•˜ë„¤ì˜" ê°™ì´ ì–´ìƒ‰í•œ íŒ¨í„´ ì •ë¦¬
        comment = re.sub(r'(ê³ ê³ |ã„±ã„±|ê°€ì¦ˆì•„|ë¬´ë¸Œ)(í•˜ë„¤ì—¬|í•˜ë„¤ì˜)', r'\1', comment)
        
        # ë„ˆë¬´ ë”°ëœ»í•˜ê±°ë‚˜ ì¼€ì–´í•˜ëŠ” ë‰˜ì•™ìŠ¤ í•„í„°ë§
        soft_phrases = [
            "ê´œì°®ìœ¼ì‹¤ ê±°ì˜ˆìš”", "ê´œì°®ì•„ì§ˆ ê±°ì˜ˆìš”", "ì¢‹ì€ í•˜ë£¨ ë˜ì„¸ìš”",
            "í–‰ë³µí•˜ì„¸ìš”", "ê±´ê°• ì±™ê¸°ì„¸ìš”", "í˜ë‚´ì„¸ìš”", "ì‘ì›í•©ë‹ˆë‹¤",
            "ì˜ ì±™ê¸°ì„¸ìš”", "í•„ìˆ˜ì£ ", "í•˜ì‹œë©´ ì¢‹ê² ì–´ìš”", "ì¶”ì²œë“œë¦½ë‹ˆë‹¤",
            "ë„ì›€ ë˜ì…¨ìœ¼ë©´ ì¢‹ê² ì–´ìš”", "ê´œì°®ìœ¼ì‹¤ ê±°ì˜ˆìš”", "ì˜ ë˜ì‹¤ ê±°ì˜ˆìš”"
        ]
        for p in soft_phrases:
            if p in comment:
                logger.warning(f"ë„ˆë¬´ ë”°ëœ»í•œ ë§íˆ¬ë¼ í•„í„°ë§: '{comment}'")
                return None
        
        # ì¹œë¶„ ìˆì–´ì•¼ í•  ìˆ˜ ìˆëŠ” í›ˆìˆ˜/ì”ì†Œë¦¬ í†¤ í•„í„°ë§
        harsh_coach = [
            "ê·¸ë§Œ ë§ˆì‹œë¼ë‹ˆê¹Œ", "ê·¸ë§Œ ë§ˆì‹œë¼ë‹ˆê¹", "ê·¸ë§Œ ë§ˆì…”ë¼",
            "ì •ì‹ ì°¨ë ¤ë¼", "ì •ì‹  ì°¨ë ¤ë¼", "ì ë‹¹íˆ ë§ˆì…”ìš”", "ì ë‹¹íˆ í•˜ì„¸ìš”",
            "ê·¸ë§Œ ì¢€ í•´ë¼", "ìˆ  ì¢€ ì¤„ì´ì„¸ìš”", "ê·¸ë§Œ ë§ˆì‹œ", "ì •ì‹  ì°¨ë¦¬"
        ]
        for p in harsh_coach:
            if p in comment:
                logger.warning(f"í›ˆìˆ˜/ì”ì†Œë¦¬ ëŠë‚Œì´ë¼ í•„í„°ë§: '{comment}'")
                return None
        
        # ê¸€ì ìˆ˜ ì œí•œ (2~26ì) - í”„ë¡¬í”„íŠ¸ì˜ ë‹¤ì–‘ì„± ìš”êµ¬(5~25ì)ì™€ ë§ì¶¤
        # ã…‹ã…‹, ã„·ã„·, ã……ã……ã…… ê°™ì€ ì´ˆì„± ë¦¬ì•¡ì…˜ë„ í—ˆìš©
        if len(comment) < 2:
            logger.warning(f"ë„ˆë¬´ ì§§ì€ ëŒ“ê¸€: '{comment}'")
            return None
        if len(comment) > 26:
            trimmed = comment[:26]
            # ë‹¨ì–´ ì¤‘ê°„ì—ì„œ ì˜ë ¸ìœ¼ë©´ ë§ˆì§€ë§‰ ë‹¨ì–´ í•˜ë‚˜ ì˜ë¼ë‚´ê¸°
            if ' ' in trimmed:
                trimmed = trimmed.rsplit(' ', 1)[0].strip()
            comment = trimmed
        
        logger.debug(f"í›„ì²˜ë¦¬ ì™„ë£Œ: '{comment}' (ê¸¸ì´: {len(comment)}ì)")
        return comment or None
    
    def _validate_not_duplicate(self, comment: str, actual_comments: List[str]) -> bool:
        """ìƒì„±ëœ ëŒ“ê¸€ì´ ì‹¤ì œ ëŒ“ê¸€ê³¼ ì™„ì „íˆ ë™ì¼í•˜ê±°ë‚˜ ë³¸ë¬¸ì„ ë³µì‚¬í•œì§€ í™•ì¸ (ì™„í™”ëœ ë²„ì „)"""
        if not actual_comments:
            return True  # ì‹¤ì œ ëŒ“ê¸€ì´ ì—†ìœ¼ë©´ ê²€ì¦ í†µê³¼
        
        # ìƒì„±ëœ ëŒ“ê¸€ì—ì„œ íŠ¹ìˆ˜ë¬¸ì ì œê±°í•˜ì—¬ ë¹„êµ
        comment_clean = re.sub(r'[~!?.,\s]', '', comment)
        comment_clean_korean = re.sub(r'[^ê°€-í£]', '', comment_clean)
        
        # ì‹¤ì œ ëŒ“ê¸€ê³¼ ì™„ì „íˆ ë™ì¼í•œ ê²½ìš°ë§Œ ì°¨ë‹¨
        for actual_comment in actual_comments:
            if isinstance(actual_comment, str):
                actual_text = actual_comment
            elif isinstance(actual_comment, dict):
                actual_text = actual_comment.get('content', str(actual_comment))
            else:
                actual_text = str(actual_comment)
            
            if not actual_text:
                continue
            
            # ì‹¤ì œ ëŒ“ê¸€ì—ì„œë„ íŠ¹ìˆ˜ë¬¸ì ì œê±°í•˜ì—¬ ë¹„êµ
            actual_clean = re.sub(r'[~!?.,\s]', '', actual_text)
            actual_clean_korean = re.sub(r'[^ê°€-í£]', '', actual_clean)
            
            # ì™„ì „íˆ ë™ì¼í•œ ê²½ìš°ë§Œ ì°¨ë‹¨
            if comment_clean_korean == actual_clean_korean:
                logger.debug(f"ì‹¤ì œ ëŒ“ê¸€ê³¼ ì™„ì „íˆ ë™ì¼: '{comment}' == '{actual_text}'")
                return False
        
        # ë³¸ë¬¸/ì œëª© ì™„ì „ ë³µì‚¬ë§Œ ì°¨ë‹¨
        if hasattr(self, '_current_post_content') and self._current_post_content:
            post_content = self._current_post_content
            post_title = getattr(self, '_current_post_title', '') or ''
            post_full = f"{post_title} {post_content}"
            post_clean = re.sub(r'[~!?.,\s]', '', post_full)
            post_clean_korean = re.sub(r'[^ê°€-í£]', '', post_clean)
            
            if len(comment_clean_korean) > 0 and len(post_clean_korean) > 0:
                # ëŒ“ê¸€ì´ ë³¸ë¬¸/ì œëª©ê³¼ ì™„ì „íˆ ë™ì¼í•œ ê²½ìš°ë§Œ ì°¨ë‹¨
                if comment_clean_korean == post_clean_korean:
                    logger.debug(f"ë³¸ë¬¸ê³¼ ì™„ì „íˆ ë™ì¼: '{comment}'")
                    return False
                
                # ëŒ“ê¸€ì´ ë³¸ë¬¸/ì œëª©ì˜ ì¼ë¶€ë¥¼ ê·¸ëŒ€ë¡œ ë³µì‚¬í•œ ê²½ìš° (ëŒ“ê¸€ ê¸¸ì´ê°€ ë³¸ë¬¸ì˜ 50% ì´ìƒì´ë©´ ë³µì‚¬ë¡œ ê°„ì£¼)
                if len(comment_clean_korean) >= len(post_clean_korean) * 0.5:
                    if comment_clean_korean in post_clean_korean:
                        logger.debug(f"ë³¸ë¬¸ ë‹¨ìˆœ ë³µì‚¬ ê°ì§€: '{comment}'")
                        return False
        
        return True  # í†µê³¼
    
    def _validate_keywords_in_comment(self, comment: str, keywords: List[str]) -> bool:
        """ìƒì„±ëœ ëŒ“ê¸€ì— í‚¤ì›Œë“œê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ (ì™„í™”ëœ ë²„ì „: 1ê°œ ì´ìƒ í¬í•¨ì´ë©´ í†µê³¼)"""
        if not keywords:
            return True  # í‚¤ì›Œë“œê°€ ì—†ìœ¼ë©´ ê²€ì¦ í†µê³¼
        
        comment_korean = re.sub(r'[^ê°€-í£]', '', comment)
        
        # í¬í•¨ëœ í‚¤ì›Œë“œ ê°œìˆ˜ í™•ì¸
        included_keywords = []
        for keyword in keywords:
            # í‚¤ì›Œë“œì— í•œê¸€ì´ ìˆìœ¼ë©´ í•œê¸€ë§Œ ë¹„êµ
            if re.search(r'[ê°€-í£]', keyword):
                if keyword in comment_korean:
                    included_keywords.append(keyword)
            else:
                # ìˆ«ì/ì˜ë¬¸ ë“±ì€ ì›ë¬¸ ê¸°ì¤€ ê²€ìƒ‰
                if keyword in comment:
                    included_keywords.append(keyword)
        
        # í‚¤ì›Œë“œê°€ ìµœì†Œ 1ê°œ ì´ìƒ í¬í•¨ë˜ë©´ í†µê³¼
        if len(included_keywords) >= 1:
            return True
        
        # í‚¤ì›Œë“œê°€ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ì‹¤íŒ¨
        return False
    
    def _safe_string(self, text: str) -> str:
        """ì•ˆì „í•œ ë¬¸ìì—´ ì²˜ë¦¬"""
        if not text:
            return ""
        
        try:
            if isinstance(text, bytes):
                text = text.decode('utf-8', errors='ignore')
            else:
                text = str(text).encode('utf-8', errors='ignore').decode('utf-8')
            
            # ì œì–´ ë¬¸ì ì œê±°
            text = ''.join(char for char in text if ord(char) >= 32 or char in '\n\r\t')
            return text
        except:
            return str(text) if text else ""
    
    def _log_generation(self, title: str, content: str, actual_comments: List[str], generated_comment: str):
        """ë””ë²„ê·¸ ë¡œê·¸ ê¸°ë¡"""
        try:
            debug_log_file = "ai_debug_log.txt"
            with open(debug_log_file, 'a', encoding='utf-8') as f:
                f.write("\n" + "="*80 + "\n")
                f.write(f"[{datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] AI ëŒ“ê¸€ ìƒì„±\n")
                f.write("="*80 + "\n\n")
                
                f.write("ã€ê²Œì‹œê¸€ ì œëª©ã€‘\n")
                f.write(f"{title if title else '(ì œëª© ì—†ìŒ)'}\n\n")
                
                f.write("ã€ê²Œì‹œê¸€ ë³¸ë¬¸ã€‘\n")
                content_preview = content[:500] if content else "(ë³¸ë¬¸ ì—†ìŒ)"
                f.write(f"{content_preview}\n")
                if content and len(content) > 500:
                    f.write(f"... (ì „ì²´ {len(content)}ì ì¤‘ 500ìë§Œ í‘œì‹œ)\n")
                f.write("\n")
                
                f.write("ã€ê²Œì‹œê¸€ì˜ ì‹¤ì œ ëŒ“ê¸€ ëª©ë¡ã€‘\n")
                if actual_comments and len(actual_comments) > 0:
                    f.write(f"ì´ {len(actual_comments)}ê°œì˜ ëŒ“ê¸€ì´ ìˆìŠµë‹ˆë‹¤:\n")
                    for i, comment in enumerate(actual_comments, 1):
                        if isinstance(comment, str):
                            comment_text = comment
                        elif isinstance(comment, dict):
                            comment_text = comment.get('content', str(comment))
                        else:
                            comment_text = str(comment)
                        f.write(f"  {i}. {comment_text}\n")
                else:
                    f.write("(ì´ ê²Œì‹œê¸€ì—ëŠ” ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤)\n")
                f.write("\n")
                
                f.write("ã€AIê°€ ìƒì„±í•œ ëŒ“ê¸€ã€‘\n")
                f.write(f"{generated_comment}\n")
                f.write("\n" + "="*80 + "\n\n")
        except Exception as e:
            logger.debug(f"ë””ë²„ê·¸ ë¡œê·¸ ê¸°ë¡ ì˜¤ë¥˜: {e}")
    
    def can_generate_comment(self, post_content: str) -> bool:
        """ê²Œì‹œê¸€ ë‚´ìš©ì´ ëŒ“ê¸€ ìƒì„± ê°€ëŠ¥í•œì§€ íŒë‹¨"""
        try:
            if not post_content:
                return False
            
            safe_content = self._safe_string(post_content)
            if len(safe_content.strip()) < 10:
                return False
            
            return True
        except:
            return False
